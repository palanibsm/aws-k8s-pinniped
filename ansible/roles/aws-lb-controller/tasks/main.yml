---
- name: Verify kubectl access
  become_user: ubuntu
  command: kubectl get nodes
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config
  register: kubectl_check
  changed_when: false

- name: Install Helm
  become: yes
  shell: |
    curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  args:
    creates: /usr/local/bin/helm

- name: Add AWS EKS Helm repo
  become_user: ubuntu
  command: helm repo add eks https://aws.github.io/eks-charts
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config
  register: helm_repo_add
  failed_when: false
  changed_when: "'already exists' not in helm_repo_add.stderr"

- name: Update Helm repos
  become_user: ubuntu
  command: helm repo update
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config

- name: Get VPC ID from Terraform
  set_fact:
    vpc_id: "{{ lookup('pipe', 'cd /mnt/c/code/cka/k8s-prod/terraform && terraform output -raw vpc_id') }}"
  delegate_to: localhost
  run_once: true

- name: Create service account for AWS Load Balancer Controller
  become_user: ubuntu
  command: kubectl create serviceaccount aws-load-balancer-controller -n kube-system
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config
  register: sa_create
  failed_when: false
  changed_when: "'created' in sa_create.stdout"

- name: Install AWS Load Balancer Controller via Helm
  become_user: ubuntu
  command: >
    helm upgrade --install aws-load-balancer-controller
    eks/aws-load-balancer-controller
    -n kube-system
    --set clusterName={{ cluster_name }}
    --set region={{ aws_region }}
    --set vpcId={{ vpc_id }}
    --set serviceAccount.create=false
    --set serviceAccount.name=aws-load-balancer-controller
    --set enableCertManager=true
    --wait
    --timeout=5m
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config
  register: albc_install

- name: Wait for AWS Load Balancer Controller to be ready
  become_user: ubuntu
  command: kubectl rollout status deployment/aws-load-balancer-controller -n kube-system --timeout=300s
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config
  register: albc_ready
  retries: 5
  delay: 30
  until: albc_ready.rc == 0
  changed_when: false

- name: Verify AWS Load Balancer Controller pods
  become_user: ubuntu
  command: kubectl get pods -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config
  register: albc_pods
  changed_when: false

- name: Display AWS Load Balancer Controller status
  debug:
    var: albc_pods.stdout_lines